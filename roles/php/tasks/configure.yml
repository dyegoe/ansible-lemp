- name: [configure] unset {{ php['conf_file'] }} listen port
  lineinfile:
    dest: "{{ php['conf_file'] }}"
    backrefs: yes
    state: present
    regexp: "^(;|)(listen = 127.0.0.1:9000)$"
    line: ";\\2"

- name: [configure] set {{ php['conf_file'] }} listen socket
  lineinfile:
    dest: "{{ php['conf_file'] }}"
    backrefs: yes
    state: present
    regexp: "^(;|)(listen = /run/php-fpm/www.sock)$"
    line: "\\2"

- name: [configure] set {{ php['conf_file'] }} listen.acl_users
  lineinfile:
    dest: "{{ php['conf_file'] }}"
    backrefs: yes
    state: present
    regexp: "^(;|)(listen.acl_users = nginx)$"
    line: "\\2"

- name: [configure] set {{ php['ini_file'] }} cgi.fix_pathinfo
  lineinfile:
    dest: "{{ php['ini_file'] }}"
    backrefs: yes
    state: present
    regexp: "^(;|)(cgi.fix_pathinfo=)(.*)$"
    line: "\\20"

- name: [configure] unset {{ php['nginx_conf_file'] }} server tcp
  lineinfile:
    dest: "{{ php['nginx_conf_file'] }}"
    backrefs: yes
    state: present
    regexp: "^( *)(#|)(server *)(127.0.0.1:9000;)$"
    line: "\\1#\\3\\4"

- name: [configure] set {{ php['nginx_conf_file'] }} server socket
  lineinfile:
    dest: "{{ php['nginx_conf_file'] }}"
    backrefs: yes
    state: present
    regexp: "^( *)(#|)(server *)(unix:/run/php-fpm/www.sock;)$"
    line: "\\1#\\3\\4"

- name: [configure] enable and start php-fpm service
  systemd:
    state: restarted
    enabled: yes
    name: php-fpm